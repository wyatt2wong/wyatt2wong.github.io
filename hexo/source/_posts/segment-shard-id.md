---
title: 号段ID与业务全局ID设计
categories:
  - ["分布式系统"]
---

# 号段ID
> 顾名思义，通过存储（如rdms、kv-store等）最大ID，由节点向存储申请一段连续ID段到本地分配，来满足分布式系统对高吞吐生成全局唯一ID的需求。

### 优化点
> 预加载
>  - 加载ID段长度：MAX(申请下限,MIN(申请上限, 时间桶（如小时/分钟等）QPS * 希望缓冲时长(秒)))
>    - 时间桶QPS：时间桶开始时间戳+LongAddr(递增随机到数组一个元素，查时sum，适合写多读少统计)，当前时间>时间桶范围时，cas初始化开始时间戳和LongAddr
>  - 双ID段：正式+预备，正式ID段分配率≥阈值，且预备ID段未初始，则线程cas竞争预加载ID段（双重检测） 

> 多计数器： 每1-N个一致性哈希虚拟节点用一个号段计数器，减少cas竞争率

--------------------------------------------------------------------------

# 业务全局ID

### 目标
- 生成速率 ≥ 百万ID/s
- 无时间回拨风险
- 弹性扩缩容
- 拆合冷热分片
- 同所属业务ID（如C端用户）数据(如订单)在同分片
- 迁移数据量低，且不中断服务

### 方案
- 哈希算法：混合xxhash64+murmurhash64
- 哈希环：16位(65536个虚拟节点)，每个虚拟节点对应一个物理分片
- ID结构：64位8字节，高16位为分片ID（哈希环虚拟节点），低48位为号段ID

### 生成逻辑
``` java
short shardGene = (xxhash64(所属业务ID) ^ murmurhash64(所属业务ID)) & 0xFFFF;
long orderNo = shardGene << 48 | (segment.generate(1) & 0xFFFFFFFFFFFF);
```

### 路由
``` java
TreeMap<Short, Shard> shardMap = 配置中心热加载;
short shardGene = (req.getOrderNo() >> 48) & 0xFFFF;
Shard shard = shardMap.ceilingEntry(shardGene); // 查找分片
```

### 拆合冷热分片
- 路由表变更
  - 新旧物理分片按映射的虚拟节点，更新到路由表
- 数据迁移
  - 迁移：全量+增量同步源分片数据到目标分片
  - 切流：将源虚拟节点的流量，按比例(如模序号)滚动(如每次5%+1分钟监控)切到目标分片
    - 回退：实现数据双向同步，通过cas(version)控制并发更新

### 安全
- ID有序性
  - 按特定规则换位：返回ID前，根据规则及其入参（如虚拟节点编号）从指定位开始调换
  - 请求时，根据特定位标识，恢复位的位置
